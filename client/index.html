<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>SSHy.us</title>

	<script type="text/javascript">
		var wsproxyURL = "ws://localhost:5999/"
		var ws, transport, term = null

		// Since firefox renders at a different resolution to the rest we can identify it and apply special rules
		var isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;

		var term_cols = Math.floor(window.innerWidth / 10) - (isFirefox ? -2 : 0)
		var	term_rows = Math.floor(window.innerHeight / 19) - (isFirefox ? 1 : -3)
	</script>

	<link rel="stylesheet" href="css/fonts.css" />
	<link rel="stylesheet" href="css/main.css" />
	<link rel="stylesheet" href="css/sidenav.css" />
	<link rel="stylesheet" href="css/xterm.css" />

	<!-- Core defines -->
	<script type="text/javascript" src="js/defines.js"></script>

	<!-- Terminal Scripts -->
	<script type="text/javascript" src="js/Libraries/xterm.js"></script>
	<script type="text/javascript" src="js/colorScheme.js"></script>

	<!-- Cryptography Libraries -->
	<script src="js/Libraries/BigInteger.min.js"></script>
	<script src="js/Libraries/struct.min.js"></script>
	<script src="js/Libraries/utilities.min.js"></script>
	<script src="js/Libraries/aes.min.js"></script>
	<script src="js/Libraries/sha1.min.js"></script>
	<script src="js/Libraries/hmac.min.js"></script>

	<!-- SShy Scripts -->
	<script src="js/crypto.js"></script>
	<script src="js/message.js"></script>
	<script src="js/transport.js"></script>
	<script src="js/parceler.js"></script>
	<script src="js/auth_handler.js"></script>
	<script src="js/dh_group1.js"></script>
	<script src="js/dh_group_ex.js"></script>

	<script type="text/javascript">
		window.onload = function() {
			document.getElementById('login_cred').style.display = "block";
			setColorScheme(colorScheme_ashes)
		};

		// Run every time the webpage is resized
		window.onresize = function resize() {
			// recalculate the term_cols and rows
			term_cols = Math.floor(window.innerWidth / 10) - (isFirefox ? -2 : 0)
			term_rows = Math.floor(window.innerHeight / 19) - (isFirefox ? 1 : -3)

			if (ws && transport) {
				term.resize(term_cols, term_rows)
				transport.auth.resize_pty(term_cols, term_rows)
			}
		}

		function toggleNav(size){
			document.getElementById("settingsNav").style.width = size
		}

		// Rudimentary checks that an IP address is external and is a valid hostname or IP address
		function validate(id, text) {
			if (!text) {
				document.getElementById(id).style.borderBottom = 'solid 2px #ff4d4d'
			} else {
				if (id == "ipaddress") {
					// incase we have a error for the port
					if (text.includes(':')) {
						if (!validate_port(text.split(':')[1])) {
							document.getElementById(id).style.borderBottom = 'solid 2px #ff4d4d'
							return
						} else {
							document.getElementById(id).style.borderBottom = 'solid 2px #c9c9c9'
							document.getElementById('failure').style.display = "none"
						}
					} else {
						// if we're not doing ports then hide the failure message
						document.getElementById('failure').style.display = "none"
					}
					// test for valid domain name
					if (!/^([a-z0-9]+\.)*[a-z0-9]+\.[a-z]+(\:[0-9]{1,5})?$/.test(text)) {
						if (check_internal(text)) {
							display_error("Could no resolve hostname: Please use an external address")
						}
						// test ip aswell.
						if (!/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$|(\:[0-9]{1,5}))){4}$/.test(text)) {
							document.getElementById(id).style.borderBottom = 'solid 2px #ff4d4d'
							return
						} else {
							if (check_internal(text)) {
								display_error("Could no resolve hostname: Please use an external address")
							}
							document.getElementById(id).style.borderBottom = 'solid 2px #c9c9c9'
							return
						}
						document.getElementById(id).style.borderBottom = 'solid 2px #ff4d4d'
						return
					}
				}
				document.getElementById(id).style.borderBottom = 'solid 2px #c9c9c9'
			}
		}
		// Validates the port is 0 > port < 65536
		function validate_port(port_num) {
			if (port_num > 0 && port_num < 65536) {
				return port_num
			} else {
				display_error("Invalid port: port must be between 1 - 65535")
				validate('ipaddress', '')
			}
		}
		// checks for 10.*.*.*, 192.168.*.*, 172.16.*.*, 127.0.0.1 & loocalhost
		function check_internal(ip_address) {
			if (/10\.\d+\.\d+\.\d+/.test(ip_address) || /192\.168\.\d+\.\d+/.test(ip_address) || /172\.16\.\d+\.\d+/.test(ip_address)) {
				return true
			} else if (ip_address == '127.0.0.1' || ip_address == 'localhost') {
				return true
			}

			return false
		}
		// Displays a given err on the page
		function display_error(err) {
			// remove the loading cog and set the 'connecting' to connect
			document.getElementById('load-container').style.display = "none"
			document.getElementById('connect').value = "connect"

			document.getElementById('failure').innerText = err
			document.getElementById('failure').style.display = "block"
		}
		// Starts the SSH client in scripts/transport.js
		function startSSHy() {
			var html_ipaddress = document.getElementById('ipaddress').value
			var html_username = document.getElementById('username').value
			var html_password = document.getElementById('password').value

			if (!html_ipaddress) {
				document.getElementById('ipaddress').value = html_ipaddress = "138.68.148.147"
				document.getElementById('username').value = html_username = "dunessh"
			}

			// find the port number
			if (html_ipaddress.includes(':')) {
				var split = html_ipaddress.split(':')
				html_ipaddress = split[0]
				html_port = validate_port(split[1])
			} else {
				html_port = 22
			}

			if (check_internal(html_ipaddress) == true) {
				display_error("Could no resolve hostname: Please use an external address")
				return
			}

			if (html_username.length == 0 || html_password.length == 0) {
				validate('username', html_username)
				validate('password', html_password)
				return
			}

			// Error checking is done so remove any currently displayed errors
			document.getElementById('failure').style.display = "none"
			document.getElementById('connect').value = 'Connecting...'
			document.getElementById('load-container').style.display = "block"

			// Opens the websocket!
			ws = new WebSocket(wsproxyURL + html_ipaddress + ':' + html_port, 'base64')
			// Sets up websocket listeners
			ws.onopen = function(e) {
				transport = new SSHyClient.Transport(ws)
			}

			ws.onclose = function(e) {
				if (ws.readyState > 1) {
					display_error("Could not resolve hostname: " + html_ipaddress + ":" + html_port)
					validate('ipaddress', '')
				}
			}

			ws.onmessage = function(e) {
				transport.handle(atob(e.data))
			}
		}

		function startxtermjs() {
			// clear the modal elements on screen
			document.getElementById('load-container').style.display = "none";
			document.getElementById('login_cred').style.display = "none";
			// Define the terminal rows/cols
			term = new Terminal({
				cols: term_cols,
				rows: term_rows
			})
			// start xterm.js
			term.open(document.getElementById('terminal'), true)

			// sets up some listeners for the terminal (keydown, paste)
			term.textarea.onkeydown = function(e) {
				if (!ws || !transport) { // check for websocket..
					return
				}

				// So we don't spam single control characters
				if (e.key.length > 1 && (e.altKey || e.ctrlKey || e.metaKey || e.shiftKey)) {
					return
				}
				var command = {
					key: null
				}

				// Decides if the keypress is an alphanumeric character or needs escaping
				if (e.key.length == 1 && !(e.altKey || e.ctrlKey || e.metaKey)) {
					command.key = e.key
				} else if(e.key.length == 1 && (e.shiftKey && e.ctrlKey)){
					// allows ctrl + shift + v for pasting
					if(e.key != 'V'){
						e.preventDefault()
					}
				} else {
					//xtermjs is kind enough to evaluate our special characters instead of having to translate every char ourself
					command = term.evaluateKeyEscapeSequence(e)
				}

				return command.key == null ? null : transport.expect_key(command.key)
			}

			//TODO: Find work around for firefox
			term.textarea.onpaste = function(ev) {
				if (ev.clipboardData) {
					var text = ev.clipboardData.getData('text/plain');

					transport.expect_key(text)

				}
			}
		}
	</script>
</head>

<body>
	<div id="terminal"></div>
	<div id="settingsNav" class="sidenav">
		<a href="javascript:void(0)" class="closebtn" onclick="toggleNav('0px')">&times;</a>
		<a href="javascript:void(0)" onclick="cycleColorSchemes(1)">Cycle ColorScheme</a>
	</div>

	<span class="icon-cogs" onclick="toggleNav('250px')"></span>

	<div id="login_cred" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2><span class="icon-lock"></span> SSHv2 Login</h2>
			</div>
			<div class="modal-body">
				<table style="width: 100%">
					<tr>
						<td><span class="icon-address-book"></span> IP Address:</td>
						<td><input type="text" id="ipaddress" placeholder="sshy.us(:22)" style="width: 90%" onblur="validate(this.id, this.value)"></td>
					</tr>
					<tr>
						<td><span class="icon-user-circle-o"></span> Username:</td>
						<td><input type="text" id="username" placeholder="username" style="width: 90%" onblur="validate(this.id, this.value)"></td>
					</tr>
					<tr>
						<td><span class="icon-eye"></span> Password:</td>
						<td><input type="password" id="password" style="width: 90%" onblur="validate(this.id, this.value)"></td>
					</tr>
				</table>
				<i id="failure" class="failure"></i>
				<input type="button" id="connect" class="button" value="Connect" onclick="startSSHy()">
			</div>
		</div>
		<div id="load-container" class="load-container">
			<svg id="load" x="0px" y="0px" viewBox="0 0 150 150">
		  		<circle id="loading-inner" cx="75" cy="75" r="60"></circle>
			</svg>
		</div>
	</div>
</body>

</html>
